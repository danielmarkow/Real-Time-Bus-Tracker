<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Real Time Bus Tracker</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
		<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
		<style>
			body { margin: 0; padding: 0; }
			#map { position: absolute; top: 0; bottom: 0; width: 100%; }
		</style>
    </head>
    <body>
        <div id="map"></div>
    </body>
    <script src="accessToken.js"></script>
    <script>
        mapboxgl.accessToken = accessToken;
        
        let markers = [];
        // create map
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-71.104081, 42.365554],
            zoom: 14
        });

        function init() {

            getBusLocations().then(
                busses => {
                    busses.forEach((bus) => {
                        let lat = bus["attributes"]["latitude"];
						let long = bus["attributes"]["longitude"];
                        const marker = new mapboxgl.Marker()
                            .setLngLat([long, lat])
                            .addTo(map);
                        
                        markers.push({id: bus["id"], bus_marker: marker})
                    })
                }
            ).catch(err => alert("An error occured setting markers: ", err))

            // setTimeout(refresh, 15000);
        }

        async function getBusLocations(){
			const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
			const response = await fetch(url);
			const json     = await response.json();
			return json.data;
		}

        function refresh() {
            getBusLocations().then(busses => {
                busses.forEach((bus) => {
                    let lat = bus["attributes"]["latitude"];
                    let long = bus["attributes"]["longitude"];
                    
                    for (let i = 0; i < markers.lenght; i++) {
                        if (markers[i]["id"] === bus["id"]) {
                            markers[i]["bus_marker"].setLngLat([long,lat]);
                            console.log("bus exists. updating...")
                            return;
                        }
                    }
                    // if bus is not found create a new marker for it
                    console.log("bus not found. creating new one...")
                    const marker = new mapboxgl.Marker()
                            .setLngLat([long, lat])
                            .addTo(map);
                    markers.push({id: bus["id"], bus_marker: marker});
                })
        })
        };

        init();

        // console.log(markers);
        


                // let bus = busses[i];
                //     let lat = bus["attributes"]["latitude"];
                //     let long = bus["attributes"]["longitude"];
                //     for (let i = 0; i < markers.lenght; i++) {
                //         if (markers[i]["id"] === bus["id"]) {
                //             markers[i]["bus_marker"].setLngLat([long,lat]);
                //             return;
                //         }
                //     }
                //     // if bus is not found create a new marker for it
                //     const marker = new mapboxgl.Marker()
                //             .setLngLat([long, lat])
                //             .addTo(map);
                //     markers.push({id: bus["id"], bus_marker: marker});
    </script>
</html>