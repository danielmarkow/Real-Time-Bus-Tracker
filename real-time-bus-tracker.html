<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Real Time Bus Tracker</title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
		<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
		<style>
			body { margin: 0; padding: 0; }
			#map { position: absolute; top: 0; bottom: 0; width: 100%; }
		</style>
    </head>
    <body>
        <div id="map"></div>
    </body>
    <script src="accessToken.js"></script>
    <script>
        mapboxgl.accessToken = accessToken;
        
        let markers = [];
        // create map
        let map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-71.104081, 42.365554],
            zoom: 13
        });

        function init() {

            getBusLocations().then(
                busses => {
                    busses.forEach((bus) => {
                        let lat = bus["attributes"]["latitude"];
						let long = bus["attributes"]["longitude"];
                        let dirColor;
                        if (bus["attributes"]["direction_id"] === 1) {
                            dirColor = "#ff0000";
                        } else {
                            dirColor = "#0000CD";
                        }
                        const marker = new mapboxgl.Marker({color: dirColor})
                            .setLngLat([long, lat])
                            .addTo(map);
                        
                        markers.push({id: bus["id"], bus_marker: marker})
                    })
                }
            )

            setInterval(refresh, 15000);
        }

        async function getBusLocations(){
			const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
			const response = await fetch(url)
                .catch(err => alert("An error occured fetching MBTA data", err));
			const json = await response.json();
			return json.data;
		}

        async function refresh() {
            let busses = await getBusLocations();
            // set to true if bus is found 
            
            for (let i = 0; i < busses.length; i++) {
                let busStatus = false;
                for (let j = 0; j < markers.length; j++) {
                    if (busses[i]["id"] === markers[j]["id"]) {
                        console.log(`bus ${busses[i]["id"]} already exists`);
                        // TODO shift color existing marker if direction changes
                        markers[i]["bus_marker"]
                            .setLngLat(
                                [busses[i]["attributes"]["longitude"],
                                busses[i]["attributes"]["latitude"]]
                            );
                        busStatus = true;
                        break;
                    }
                }
                if (!busStatus) {
                    console.log(`bus ${busses[i]["id"]} not found`)
                    let dirColor;
                        if (bus["attributes"]["direction_id"] === 1) {
                            dirColor = "#ff0000";
                        } else {
                            dirColor = "#0000CD";
                        }
                    const marker = new mapboxgl.Marker({color: dirColor})
                            .setLngLat(
                                [busses[i]["attributes"]["longitude"], 
                                busses[i]["attributes"]["latitude"]])
                            .addTo(map);
                    
                    markers.push({id: busses[i]["id"], bus_marker: marker});
                }
            }
        };

        init();

    </script>
</html>